{"version":3,"file":"dpr-observer.js","sources":["../src/helper.js","../src/index.js"],"sourcesContent":["export function isFunction(obj) {\n  return obj && typeof obj === 'function'\n}\n\n/**\n * Provide a function to get current `devicePixelRatio`.\n * `devicePixelRatio` may be modified after browser's zoom\n */\nexport function getDevicePixelRatio() {\n  let dpr = 1\n  // If in browser environment\n  if (typeof window !== 'undefined') {\n    dpr = window.devicePixelRatio || (window.screen.deviceXDPI / window.screen.logicalXDPI) || 1\n  }\n  return dpr\n}\n\nexport function supportMatchMedia() {\n  return typeof window !== 'undefined' && isFunction(window.matchMedia)\n}\n\nexport function getIEVersion() {\n  let version = 0\n  const ua = navigator.userAgent\n  if (navigator.appName === 'Microsoft Internet Explorer') {\n    new RegExp('MSIE ([0-9]{1,}[.0-9]{0,})').exec(ua)\n    version = parseFloat(RegExp.$1)\n  }\n  else if (ua.indexOf('Trident') > -1 && ua.indexOf('rv:11.0') > -1) {\n    version = 11\n  }\n  return version\n}\n\nexport const requestAnimationFrame = (\n  typeof window !== 'undefined'\n    && (\n      (window.requestAnimationFrame && window.requestAnimationFrame.bind(window))\n      || (window.msRequestAnimationFrame && window.msRequestAnimationFrame.bind(window))\n      || window.mozRequestAnimationFrame\n      || window.webkitRequestAnimationFrame\n    )\n) || function (func) {\n  return setTimeout(func, 16)\n}\n\nexport const cancelAnimationFrame = (\n  typeof window !== 'undefined'\n    && (\n      (window.cancelAnimationFrame && window.cancelAnimationFrame.bind(window))\n      || (window.msCancelAnimationFrame && window.msCancelAnimationFrame.bind(window))\n      || window.mozCancelAnimationFrame\n      || window.webkitCancelAnimationFrame\n    )\n) || function (handle) {\n  return clearTimeout(handle)\n}\n","import { version } from '../package.json'\nimport {\n  isFunction,\n  getDevicePixelRatio,\n  supportMatchMedia,\n  requestAnimationFrame,\n  cancelAnimationFrame,\n  getIEVersion\n} from './helper'\n\nconst matchMediaSupported = supportMatchMedia()\nconst isIE = !!getIEVersion()\n\nconst defaultOptions = {\n  /**\n   * Only use animation listener.\n   * This works for most of browsers.\n   */\n  onlyUseAnimationListener: false,\n  /**\n   * prefer matchMedia and fallback to animation listener if not supported.\n   */\n  fallbackToAnimationListener: true\n}\n\n/**\n * An observer for listening to the change of device pixel ratio\n *\n * @see https://developer.mozilla.org/zh-CN/docs/Web/API/Window/devicePixelRatio\n */\nclass DprObserver {\n\n  static version = version\n\n  constructor(onchange, options) {\n    options = Object.assign({}, defaultOptions, options || {})\n    if (!options.onlyUseAnimationListener && !matchMediaSupported && !options.fallbackToAnimationListener) {\n      throw new Error(\n        `DprObserver cannot run without \\`matchMedia\\` supported!\n        Please try to specify \\`fallbackToAnimationListener\\` as true to enable animation listener.`\n      )\n    }\n    if (!isFunction(onchange)) {\n      throw new Error('the required param `onchange` must be a function!')\n    }\n    this._onchange = onchange\n    // use animation listener\n    // if `onlyUseAnimationListener`is specified as true\n    // or browser is IE\n    // or `matchMedia` is not supported and `fallbackToAnimationListener` is specified as true\n    if (options.onlyUseAnimationListener || isIE\n      || (!matchMediaSupported && options.fallbackToAnimationListener)\n    ) {\n      this._createAnimationListener()\n    }\n    else {\n      this._createMediaMatcher()\n    }\n  }\n\n  _createMediaMatcher() {\n    const dpr = getDevicePixelRatio()\n    const mqString = `(resolution: ${dpr}dppx)`\n    this._mediaMatcher = window.matchMedia(mqString)\n    this._mediaMatcher.addListener(\n      this._updateListener = () => {\n        this._onchange(getDevicePixelRatio())\n\n        // recreate the media mather with the new dpr\n        this._disposeMediaMatcher()\n        this._createMediaMatcher()\n      }\n    )\n  }\n\n  _createAnimationListener() {\n    let dpr = getDevicePixelRatio()\n    const func = () => {\n      const newDpr = getDevicePixelRatio()\n      if (dpr !== newDpr) {\n        this._onchange && this._onchange(dpr = newDpr)\n      }\n      requestAnimationFrame(func)\n    }\n    this._updateListener = requestAnimationFrame(func)\n  }\n\n  _disposeMediaMatcher() {\n    if (this._mediaMatcher) {\n      this._mediaMatcher.removeListener(this._updateListener)\n      this._mediaMatcher = null\n    }\n  }\n\n  _disposeAnimationListener() {\n    this._updateListener && cancelAnimationFrame(this._updateListener)\n  }\n\n  /**\n   * Dispose the observer\n   */\n  dispose() {\n    this._disposeAnimationListener()\n    this._disposeMediaMatcher()\n    if (this._updateListener) {\n      this._updateListener = null\n    }\n    this._onchange = null\n  }\n\n  /**\n   * Get current device pixel ratio\n   * @return {Number} Current device pixel ratio\n   */\n  getDpr() {\n    return getDevicePixelRatio()\n  }\n\n}\n\nexport default DprObserver\n"],"names":["isFunction","obj","getDevicePixelRatio","dpr","window","devicePixelRatio","screen","deviceXDPI","logicalXDPI","supportMatchMedia","matchMedia","getIEVersion","version","ua","navigator","userAgent","appName","RegExp","exec","parseFloat","$1","indexOf","requestAnimationFrame","bind","msRequestAnimationFrame","mozRequestAnimationFrame","webkitRequestAnimationFrame","func","setTimeout","cancelAnimationFrame","msCancelAnimationFrame","mozCancelAnimationFrame","webkitCancelAnimationFrame","handle","clearTimeout","matchMediaSupported","isIE","defaultOptions","onlyUseAnimationListener","fallbackToAnimationListener","DprObserver","onchange","options","Error","_onchange","_createAnimationListener","_createMediaMatcher","mqString","_mediaMatcher","addListener","_updateListener","_disposeMediaMatcher","newDpr","removeListener","_disposeAnimationListener","dispose","getDpr"],"mappings":"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"}